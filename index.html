<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dotswitch ‚Ä¢ Mini‚ÄëGames</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{color:white;font-family:'Poppins',Helvetica,Arial,sans-serif;}
    section{padding:1rem;border-radius:16px;margin:1.5rem;}
    #game1{background-color:#b34700; overscroll-behavior: contain;}
    #game2{background-color:#001f3f;}
    #game3{background-color:#b34700;}
    #game4{background-color:#001f3f;}
    .next-btn{position:absolute;top:10px;right:10px;}
    canvas,img{max-width:100%;}
    .choice{border:1px solid rgba(255,255,255,0.4);padding:10px;border-radius:10px;text-align:center;cursor:pointer;}
    .choice.active{background:rgba(255,255,255,0.2);}    
    /* micro haptic visual feedback */
    .pop{animation:pop .12s ease}
    @keyframes pop{from{transform:scale(.95)}to{transform:scale(1)}}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .thumb{border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.2);cursor:pointer}
    .thumb img{width:100%;height:120px;object-fit:cover;display:block}
    .thumb .label{padding:8px;text-align:center}
    .thumb.active{outline:2px solid #7ee787;background:rgba(126,231,135,.1)}
  </style>
</head>
<body>

  <!-- =================== Game 4 =================== -->
  <section id="game4" class="text-center position-relative">
    <!-- last game: no next button -->
    <h2>üëî Style Selector</h2>
    <p>Pick what feels like you, then we‚Äôll suggest a catalog to browse.</p>

    <h5 class="mt-3">Do you like Patterns?</h5>
    <div class="grid-2 mb-3" data-group="pattern">
      <div class="thumb" onclick="selectThumb(this,'pattern','Patterned')">
        <img src="https://img.freepik.com/free-vector/orange-irregular-organic-lines-seamless-pattern_1409-4190.jpg?semt=ais_hybrid&w=740&q=80" alt="Patterned"><div class="label">Patterned</div>
      </div>
      <div class="thumb" onclick="selectThumb(this,'pattern','Plain')">
        <img src="https://images.unsplash.com/photo-1650802218127-3b9c06de0d29?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cGxhaW4lMjBjb2xvcnxlbnwwfHwwfHx8MA%3D%3D&fm=jpg&q=60&w=3000" alt="Plain"><div class="label">Plain</div>
      </div>
    </div>

    <h5>Do you like Collars?</h5>
    <div class="grid-2 mb-3" data-group="collar">
      <div class="thumb" onclick="selectThumb(this,'collar','Collars')">
        <img src="https://collarsandco.com/cdn/shop/products/Collars-and-Co-Semi-Spread-Navy-Long-Sleeve-Close.jpg?v=1668033132" alt="Collars"><div class="label">Collars</div>
      </div>
      <div class="thumb" onclick="selectThumb(this,'collar','No Collars')">
        <img src="https://cdn.shopify.com/s/files/1/0896/8970/files/Screenshot_2023-02-14_at_4.35.36_PM_480x480.png?v=1676459348" alt="No Collars"><div class="label">No Collars</div>
      </div>
    </div>

    <h5>Are You More Ranveer Singh or Rajkummar Rao?</h5>
    <div class="grid-2 mb-3" data-group="persona">
      <div class="thumb" onclick="selectThumb(this,'persona','Ranveer')">
        <img src="https://goyahills.com/wp-content/uploads/2025/03/Ranveer-Singh.png" alt="Ranveer"><div class="label">Ranveer</div>
      </div>
      <div class="thumb" onclick="selectThumb(this,'persona','Rajkummar')">
        <img src="https://beyondbollywood.home.blog/wp-content/uploads/2020/07/rajkummar-rao.jpg" alt="Rajkummar Rao"><div class="label">Rajkummar Rao</div>
      </div>
    </div>

    <div class="mb-3" style="max-width:520px;margin:0 auto;">
      <label class="form-label">Tell us one word about yourself</label>
      <input id="oneWord" class="form-control form-control-sm" placeholder="e.g., minimal, edgy, playful" />
    </div>
    <button id="styleGo" class="btn btn-success btn-sm">Get a catalog</button>
  </section>
  

  <!-- Global Result Lightbox (Bootstrap Modal) -->
  <div class="modal fade" id="resultLightbox" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background:#111; color:#fff; border-radius:16px; border:1px solid rgba(255,255,255,.15)">
        <div class="modal-body text-center p-3 p-md-4">
          <div class="ratio ratio-1x1 mb-3" style="max-width:220px; margin:0 auto;">
            <video id="resultAnim" src="https://cdn-icons-mp4.flaticon.com/512/19016/19016331.mp4" autoplay loop muted playsinline preload="auto" style="border-radius:12px; object-fit:cover;"></video>
          </div>
          <h5 id="resultMsg" class="mb-3"></h5>
          <div id="resultCTA" class="mb-2"></div>
          <button type="button" class="btn btn-success w-100" data-bs-dismiss="modal">Got it</button>
        </div>
      </div>
    </div>
  </div>

  <!-- =================== Game 2 =================== -->
  <section id="game2" class="position-relative text-center">
    <button class="btn btn-light btn-sm next-btn" onclick="document.getElementById('game3').scrollIntoView({behavior:'smooth'})">Next game ‚Üí</button>
    <h2>üç´ Snack it Before It Melts</h2>
    <p>Tap the cookie as fast as you can!</p>
    <div id="playfield" style="position:relative;height:300px;border:2px dashed white;border-radius:12px;margin:auto;overflow:hidden;"></div>
    <div class="mt-2">
      <button id="startGame2" class="btn btn-success btn-sm">Start</button>
      <p id="cookieResult" class="visually-hidden"></p>
    </div>
  </section>

  <!-- =================== Game 3 =================== -->
  <section id="game3" class="text-center position-relative">
    <button class="btn btn-light btn-sm next-btn" onclick="document.getElementById('game4').scrollIntoView({behavior:'smooth'})">Next game ‚Üí</button>
    <h2>Let's Find Your Favorite Flavor</h2>
    <p class="mb-1">üëï Find Your Fit</p>
    <p>Three quick choices to find your vibe.</p>
    <h2>Is Your Style more...?</h2>
    <div class="mb-3">
      <div class="choice" onclick="selectChoice(this,'style','Minimal')">Minimal</div>
      <div class="choice" onclick="selectChoice(this,'style','Maximal')">Over The Top</div>
    </div>
    <h2>Do you think you are more Calm or Bold?</h2>
    <div class="mb-3">
      <div class="choice" onclick="selectChoice(this,'pace','Calm')">Calm</div>
      <div class="choice" onclick="selectChoice(this,'pace','Bold')">Bold</div>
    </div>
    <h2>Are You a Morning Person or Night?</h2>
    <div class="mb-3">
      <div class="choice" onclick="selectChoice(this,'time','Morning')">Morning</div>
      <div class="choice" onclick="selectChoice(this,'time','Night')">Night</div>
    </div>
    <button id="fitSubmit" class="btn btn-success btn-sm">Reveal my flavor</button>
    <p id="fitResult" class="visually-hidden"></p>
  </section>

  <!-- =================== Game 1 =================== -->
  <section id="game1" class="position-relative text-center">
    <button class="btn btn-light btn-sm next-btn" onclick="document.getElementById('game2').scrollIntoView({behavior:'smooth'})">Next game ‚Üí</button>
    <h2>üßº Clean the Mess</h2>
    <p>Tap or swipe to wipe the jacket clean.</p>
    <div style="position:relative;display:inline-block;">
      <img id="jacketImg" src="https://icon2.cleanpng.com/20240406/lvs/transparent-jacket-green-jacket-hooded-jacket-dark-olive-green-dark-olive-green-jacket-with-transparent-hood6610f4651a6214.23911245.webp" alt="Jacket">
      <canvas id="wipeCanvas" style="position:absolute;top:0;left:0;touch-action:none;"></canvas>
    </div>
    <div class="mt-2">
      <button id="submitWipe" class="btn btn-success btn-sm">Submit</button>
      <p id="wipeResult" class="visually-hidden"></p>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  // ======== Lightbox helper ========
  const resultModal = new bootstrap.Modal(document.getElementById('resultLightbox'));
  const resultMsgEl = document.getElementById('resultMsg');
  const resultAnim = document.getElementById('resultAnim');
  const resultCTA = document.getElementById('resultCTA');
  function showResult(msg, ctaHtml){
    resultMsgEl.textContent = msg;
    resultCTA.innerHTML = ctaHtml || '';
    try{ resultAnim.currentTime = 0; resultAnim.play().catch(()=>{}); }catch(_){ }
    resultModal.show();
  }

  // ============== Game 1: Clean the Mess (wipe sound + no scroll) ==============
  const canvas=document.getElementById('wipeCanvas');
  const img=document.getElementById('jacketImg');
  const ctx=canvas.getContext('2d');
  const wipeAudioSrc='https://res.cloudinary.com/do7w7isgi/video/upload/v1761799628/window-wipe-106600_qq1hvd.mp3';
  const baseWipeAudio=new Audio(wipeAudioSrc); baseWipeAudio.preload='auto'; baseWipeAudio.volume=0.4;
  let lastWipeSound=0;
  function playWipeSound(){
    const now=performance.now();
    if(now-lastWipeSound>120){
      const a=baseWipeAudio.cloneNode(); a.volume=0.4; a.play().catch(()=>{}); lastWipeSound=now;
    }
  }
  function resize(){ canvas.width=img.clientWidth; canvas.height=img.clientHeight; ctx.fillStyle='rgba(255,255,255,0.3)'; ctx.fillRect(0,0,canvas.width,canvas.height); }
  window.addEventListener('resize',resize); img.onload=resize; if(img.complete) resize();
  let down=false;
  canvas.addEventListener('mousedown',()=>{down=true});
  canvas.addEventListener('mouseup',()=>{down=false});
  canvas.addEventListener('mouseleave',()=>{down=false});
  canvas.addEventListener('mousemove',e=>{ if(!down) return; ctx.clearRect(e.offsetX-15,e.offsetY-15,30,30); playWipeSound(); });
  // touch
  canvas.addEventListener('touchstart',(e)=>{down=true; e.preventDefault();},{passive:false});
  canvas.addEventListener('touchend',(e)=>{down=false; e.preventDefault();},{passive:false});
  canvas.addEventListener('touchmove',(e)=>{ if(!down) return; e.preventDefault(); const rect=canvas.getBoundingClientRect(); const t=e.touches[0]; const x=t.clientX-rect.left; const y=t.clientY-rect.top; ctx.clearRect(x-18,y-18,36,36); playWipeSound(); },{passive:false});
  document.getElementById('submitWipe').onclick=function(){
    const data=ctx.getImageData(0,0,canvas.width,canvas.height).data; let clear=0;
    for(let i=3;i<data.length;i+=4){ if(data[i]===0) clear++; }
    const pct=Math.round(clear/(canvas.width*canvas.height)*100);
    let msg='';
    if(pct>=100) msg="Spotless! You‚Äôve earned ‚Çπ150 off your next order.";
    else if(pct>=50) msg="Good, could have shined better! You‚Äôve earned ‚Çπ50 off your next order.";
    else msg="Hmm, not good enough. Better luck next time.";
    showResult(msg);
  };

  // ============== Game 2: Snack it Before It Melts (faster + haptics) ==============
  let caught=0, timer; const play=document.getElementById('playfield');
  function spawnCookie(){
    const img=document.createElement('img');
    img.src='https://png.pngtree.com/png-vector/20250425/ourmid/pngtree-chocolate-chip-cookie-icon-white-background-png-image_16100260.png';
    img.style.width='60px'; img.style.position='absolute';
    img.style.left=Math.random()*(play.clientWidth-60)+'px';
    img.style.top =Math.random()*(play.clientHeight-60)+'px';

    const hit=()=>{ caught++; img.classList.add('pop'); if('vibrate' in navigator){ try{ navigator.vibrate(18);}catch(_){}} img.remove(); };
    img.addEventListener('pointerdown',hit,{once:true});
    img.addEventListener('touchstart',hit,{once:true,passive:true});
    img.addEventListener('mousedown',hit,{once:true});
    img.addEventListener('click',hit,{once:true});

    play.appendChild(img);
    setTimeout(()=>img.remove(),700);
  }
  function startGame2(){
    caught=0; document.getElementById('cookieResult').textContent='';
    [...play.querySelectorAll('img')].forEach(n=>n.remove());
    timer=setInterval(spawnCookie,900);
    setTimeout(()=>{ clearInterval(timer); [...play.querySelectorAll('img')].forEach(n=>n.remove()); showResult(caught>=5?"Sweet reflexes! Grab your free sample with your next order.":"Almost there!"); },15000);
  }
  document.getElementById('startGame2').onclick=startGame2;

  // ============== Game 3: Find Your Fit ==============
  const selections={};
  function selectChoice(el,group,val){
    document.querySelectorAll('.choice').forEach(c=>{ if(c.getAttribute('onclick') && c.getAttribute('onclick').includes(`,'${group}',`)) c.classList.remove('active'); });
    el.classList.add('active'); selections[group]=val;
  }
  document.getElementById('fitSubmit').onclick=function(){
    let flavor='The Easy Drip';
    if(selections.pace==='Bold'&&selections.time==='Morning') flavor='The Bold Classic';
    else if(selections.time==='Night'&&selections.pace==='Bold') flavor='The Midnight Espresso';
    showResult(`Your vibe: ${flavor}. You + ${flavor} = perfect fit. Here‚Äôs 15% off your first one.`);
  };

  // ============== Game 4: Style Selector (calls backend to get catalog URL) ==============
  const g4 = { pattern:null, collar:null, persona:null };
  function selectThumb(el, group, val){
    // toggle visuals inside that group
    const wrap = el.parentElement; [...wrap.querySelectorAll('.thumb')].forEach(t=>t.classList.remove('active'));
    el.classList.add('active'); g4[group]=val;
  }
  document.getElementById('styleGo').addEventListener('click', async ()=>{
    const word = (document.getElementById('oneWord').value||'').trim();
    if(!g4.pattern || !g4.collar || !g4.persona){ showResult('Pick one option in each row to continue.'); return; }
    const payload = { pattern:g4.pattern, collar:g4.collar, persona:g4.persona, word };
    const url = await fetchCatalogURL(payload);
    const safe = url || mockCatalogURL(payload);
    const cta = `<a class="btn btn-primary w-100" target="_blank" rel="noopener" href="${safe}">Open catalog</a>`;
    showResult('Here‚Äôs a catalog that matches your vibe.', cta);
  });

  async function fetchCatalogURL(payload){
    try{
      // IMPORTANT: Do not call OpenAI directly from the browser with a secret key.
      // Instead, POST to your backend proxy which holds OPENAI_API_KEY server-side.
      // Example endpoint in Django/Render: /api/fashion-catalog
      const resp = await fetch('https://infamous-spooky-spell-vwgv54x7gwv36jp-8000.app.github.dev/api/fashion-catalog/',{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      if(!resp.ok) throw new Error('bad');
      const data = await resp.json();
      return data.url; // expected { url: "https://brand.com/collection/..." }
    }catch(e){ return null; }
  }

  function mockCatalogURL(p){
    // simple fallback mapper for demo
    if(p.persona==='Ranveer' && p.pattern==='Patterned') return 'https://www.zara.com/in/';
    if(p.persona==='Rajkummar' && p.pattern==='Plain') return 'https://www.uniqlo.com/in/en/';
    if(p.collar==='Collars') return 'https://collarsandco.com/';
    return 'https://www2.hm.com/en_in/men/shop-by-product/shirts.html';
  }
  </script>
</body>
</html>
